package workflow

import (
	"context"
	"fmt"
	"github.com/danbudris/vulnerabilityProcessor/pkg/version"
	"strings"

	"github.com/danbudris/vulnerabilityProcessor/pkg/api"
	prcreator "github.com/danbudris/vulnerabilityProcessor/pkg/prManager"
	"github.com/danbudris/vulnerabilityProcessor/pkg/vexManager"
)

const (
	prAutocreatedTemplate = "Pull Request auto created by Vulnerability Processor version `%s`"
)

type VexPrCreatorOpts struct {
	AuthorName          string
	AuthorEmail         string
	PrBranch            string
	VexDocumentGitPath  string
}

func VexPrCreatorHandler(m *vexManager.Manager, p *prcreator.PrCreator, opts VexPrCreatorOpts) *prCreatorHandler {
	return &prCreatorHandler{
		manager: m,
		prCreator: p,
		prAuthorName: opts.AuthorName,
		prAuthorEmail: opts.AuthorEmail,
		prBranch: opts.PrBranch,
		vexDocumentGitPath: opts.VexDocumentGitPath,
	}
}

type prCreatorHandler struct {
	manager            *vexManager.Manager
	prCreator          *prcreator.PrCreator
	prAuthorName       string
	prAuthorEmail      string
	prBranch           string
	vexDocumentGitPath string
	next               VulnerabilityHandler
}

func (h *prCreatorHandler) Handle(ctx context.Context, wCtx *Context, v *api.VulnerabilityFinding) error {
	content, err := h.manager.DocumentJson()
	if err != nil {
		return fmt.Errorf("getting document JSON while creating PR in handler: %v", err)
	}
	o := &prcreator.CreatePrOpts{
		CommitBranch:    v.VulnerabilityId,
		SourceFileBody:  content,
		DestFileGitPath: h.vexDocumentGitPath,
		AuthorName:      h.prAuthorName,
		AuthorEmail:     h.prAuthorEmail,
		CommitMessage:   commitMessage(*v),
		PrSubject:       prSubject(*v),
		PrBranch:        h.prBranch,
		PrDescription:   prDescription(*v),
		BaseBranch:      "main",
	}

	pr, err := h.prCreator.CreatePr(ctx, o)
	if err != nil {
		return fmt.Errorf("creating pr in handler: %v", err)
	}

	wCtx.AddPullRequest(pr)

	if h.next != nil {
		return h.next.Handle(ctx, wCtx, v)
	}
	return nil
}

func (h *prCreatorHandler) SetNextHandler(handler VulnerabilityHandler) {
	h.next = handler
}

func prSubject(v api.VulnerabilityFinding) string {
	return fmt.Sprintf("%s vulnerability %s packages affecting %d resources", v.Severity, v.Title, len(v.AffectedResourceIds))
}

func commitMessage(v api.VulnerabilityFinding) string {
	return fmt.Sprintf("update VEX document to reflect vulnerability %s in %d resources", v.VulnerabilityId, len(v.AffectedResourceIds))
}

func prDescription(v api.VulnerabilityFinding) string {
	b := strings.Builder{}
	b.WriteString(fmt.Sprintf(prAutocreatedTemplate, version.Get().GitVersion))
	b.WriteString(fmt.Sprintf("\n"))
	b.WriteString(fmt.Sprintf("A vulnerability %s %s has been detected in %d resources by %s\n", v.Severity, v.VulnerabilityId, len(v.AffectedResourceIds), v.VulnerabilitySource))
	b.WriteString("Affected Resources: \n")
	for _, r := range v.AffectedResourceIds {
		b.WriteString(fmt.Sprintf("- %s\n", r))
	}
	b.WriteString("Affected Packages: \n")
	for _, p := range v.AffectedPackages {
		b.WriteString(fmt.Sprintf("- %s", p.Name))
	}
	return b.String()
}
