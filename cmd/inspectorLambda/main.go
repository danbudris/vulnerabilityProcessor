package main

import (
	"context"
	"fmt"
	"github.com/danbudris/vulnerabilityProcessor/pkg/retier"
	"os"
	"time"

	"github.com/aws/aws-lambda-go/lambda"

	"github.com/danbudris/vulnerabilityProcessor/pkg/api"
	"github.com/danbudris/vulnerabilityProcessor/pkg/inspectorHelper"
	issuecreator "github.com/danbudris/vulnerabilityProcessor/pkg/issueManager"
	"github.com/danbudris/vulnerabilityProcessor/pkg/logger"
	"github.com/danbudris/vulnerabilityProcessor/pkg/messageSources"
	prcreator "github.com/danbudris/vulnerabilityProcessor/pkg/prManager"
	"github.com/danbudris/vulnerabilityProcessor/pkg/vexManager"
	"github.com/danbudris/vulnerabilityProcessor/pkg/vulnerabilitySources"
	"github.com/danbudris/vulnerabilityProcessor/pkg/workflow"
)

func main() {
	lambda.Start(hanldeInspectorLambdaEvent)
}

func hanldeInspectorLambdaEvent(ctx context.Context, event inspectorHelper.InspectorEventbridgeEvent) (string, error) {
	var owner = os.Getenv("OWNER")
	var repo = os.Getenv("REPO")
	var email = os.Getenv("GITHUB_EMAIL")
	var prBranch = os.Getenv("PR_BRANCH")
	var vexDocumentGitPath = os.Getenv("VEX_GIT_PATH")

	logger.Info("testing line 30")

	// set up the VEX document manager
	v, err := vexManager.New("./test.vex")
	if err != nil {
		return "", fmt.Errorf("setting up vex manager: %v", err)
	}

	logger.Info("testing line 38")

	if v == nil {
		return "vex was nil, wtf?", nil
	}

	// set up the Inspector Event Handler
	inspectorHandler := workflow.NewInspector(*v)

	retrier := retier.NewWithMaxRetries(10, 10)

	// set up PR Creator handler
	o := &prcreator.Opts{
		SourceOwner: owner,
		SourceRepo:  repo,
		PrRepo:      repo,
		PrRepoOwner: owner,
	}
	prCreator := prcreator.New(retrier, o)

	prHandlerOpts := workflow.VexPrCreatorOpts{
		AuthorName:         "VEX PR Bot",
		AuthorEmail:        email,
		PrBranch:           prBranch,
		VexDocumentGitPath: vexDocumentGitPath,
	}
	prHandler := workflow.VexPrCreatorHandler(v, prCreator, prHandlerOpts)

	// set up the Issue Creator handler
	issueManagerOpts := &issuecreator.Opts{
		SourceOwner: owner,
		SourceRepo:  repo,
	}
	issueManager := issuecreator.New(retrier, issueManagerOpts)

	issueHandlerOpts := workflow.GithubIssueCreatorOpts{
		Labels: &[]string{"hey", "there", "test"},
	}
	issueHandler := workflow.IssueCreatorHandler(v, issueManager, issueHandlerOpts)

	// set up the handler chain
	prHandler.SetNextHandler(issueHandler)
	inspectorHandler.SetNextHandler(prHandler)

	// set up the workflow context containing context for executing the handler chain
	wCtx := workflow.NewContext()
	wCtx.SetVex(v)
	wCtx.FindingSource = vulnerabilitySources.InspectorV2
	wCtx.MessageSource = messageSources.EventBridge

	vulnerability, err := inspectorEventBridgeEventToVulnerabilityFinding(event, v)
	if err != nil {
		return "", fmt.Errorf("converting InspectorV2 EventBridge event to vulnerabilitiy finding: %v", err)
	}
	wCtx.AddVulnerabilitiy(vulnerability)
	wCtx.InspectorFinding = &event.Detail

	// invoke the handler chain
	return "", inspectorHandler.Handle(ctx, wCtx, vulnerability)
}

func inspectorEventBridgeEventToVulnerabilityFinding(e inspectorHelper.InspectorEventbridgeEvent, vex *vexManager.Manager) (*api.VulnerabilityFinding, error) {
	var affectedResourceIds []string
	for _, r := range e.Detail.Resources {
		affectedResourceIds = append(affectedResourceIds, r.Id)
	}

	var affectedPackages []api.Package
	for _, p := range e.Detail.PackageVulnerabilityDetails.VulnerablePackages {
		pk := api.Package{
			Arch:            p.Arch,
			Epoch:           p.Epoch,
			Name:            p.Name,
			PackageManager:  p.PackageManager,
			Release:         p.Release,
			SourceLayerHash: p.SourceLayerHash,
			Version:         p.Version,
		}
		affectedPackages = append(affectedPackages, pk)
	}

	v := &api.VulnerabilityFinding{
		Title:               e.Detail.Title,
		VulnerabilityId:     e.Detail.PackageVulnerabilityDetails.VulnerabilityId,
		MessageSource:       messageSources.EventBridge,
		VulnerabilitySource: vulnerabilitySources.InspectorV2,
		RecievedTimestamp:   time.Now().String(),
		DetectedTimestamp:   e.Detail.FirstObservedAt,
		AffectedResourceIds: affectedResourceIds,
		AffectedPackages:	 affectedPackages,
		Severity:            e.Detail.Severity,
		RawEvent:            nil,
		Vex:                 vex,
	}
	return v, nil
}
