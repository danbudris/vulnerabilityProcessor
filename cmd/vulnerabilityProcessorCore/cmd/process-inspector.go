package cmd

import (
	"context"
	"encoding/json"
	"github.com/danbudris/vulnerabilityProcessor/pkg/logger"
	"github.com/danbudris/vulnerabilityProcessor/pkg/vexManager"
	"log"
	"os"

	"github.com/spf13/cobra"
)

var versionsCmd = &cobra.Command{
	Use:   "process",
	Short: "Process a vulnerability from a file",
	Long:  "Get the versions of images in cluster",
	RunE: func(cmd *cobra.Command, args []string) error {
		err := process(cmd.Context())
		if err != nil {
			log.Fatalf("Error getting image versions: %v", err)
		}
		return nil
	},
}

func init() {
	rootCmd.AddCommand(versionsCmd)
}

func processInspector(ctx context.Context, findingEvent []byte) error {
	f := "./test.vex"
	m, err := vexManager.New(f)
	if err != nil {
		logger.Error(err, "could not load vex file")
		return err
	}
	b, err := json.Marshal(m.Document())
	if err != nil {
		logger.Error(err,"could not marshal VEX to bytes")
		return err
	}
	_, err = os.Stdout.Write(b)
	if err != nil {
		logger.Error(err,"could not write to stdout")
		return err
	}
	exists := m.GetCveById("CVE-2021-45105")
	logger.V(1).Info("Exisitng CVE")
	logger.V(1).Info("CVE Found", "CVE", exists)

	doesNotExist := m.GetCveById("CVE-2021-45105010101")
	logger.V(1).Info("Does Not Exist")
	logger.V(1).Info("CVE not found", "CVE", doesNotExist)

	return nil
}