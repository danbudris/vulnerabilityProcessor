GO_ARCH:=$(shell go env GOARCH)
GO_OS:=$(shell go env GOOS)
BINARY_NAME:=bin/vulnerabilityProcessor

.PHONY: default
default: build lint

.PHONY: build
build: vulnerabilityProcessor unit-test ## Generate binaries and run unit tests
vulnerabilityProcessor:
	GOOS=$(GO_OS) GOARCH=$(GO_ARCH) go build -o $(BINARY_NAME) github.com/danbudris/vulnerabilityProcessor

.PHONY: lint
lint: bin/golangci-lint ## Run golangci-lint
	bin/golangci-lint run

bin/golangci-lint: ## Download golangci-lint
bin/golangci-lint: GOLANGCI_LINT_VERSION?=$(shell cat .github/workflows/golangci-lint.yml | yq e '.jobs.golangci.steps[] | select(.name == "golangci-lint") .with.version' -)
bin/golangci-lint:
	curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s $(GOLANGCI_LINT_VERSION)

unit-test:
	go test ./... --cover

.PHONY clean:
	 go clean
	 rm ${BINARY_NAME}-darwin
	 rm ${BINARY_NAME}-linux
